<!doctype html>
<html class="no-js" lang="tr">
@await Component.InvokeAsync("_UILayoutHead")
<body>

    @await Component.InvokeAsync("_UILayoutHeader")
    @await Component.InvokeAsync("_UILayoutMobileMenu")
    @await Component.InvokeAsync("_UILayoutNavbar")
    @await Component.InvokeAsync("_UILayoutBreadComb")

    @RenderBody()

    @using System.Security.Claims
    <input type="hidden"
           id="currentUserEmail"
           value="@(User.FindFirst(ClaimTypes.Email)?.Value
                           ?? User.FindFirst("email")?.Value
                           ?? "")" />

    @await Component.InvokeAsync("_UILayoutFooter")

    <!-- JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.2/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        (function () {

            const emailEl = document.getElementById("currentUserEmail");
            const userEmail = (emailEl?.value || "").trim();

            if (!userEmail) {
                console.warn("SignalR: userEmail not found.");
                return;
            }

            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/hubs/notification")
                .withAutomaticReconnect()
                .build();

            function showInboxBadgePlusOne() {
                const badge = document.getElementById("inboxBadge");
                if (!badge) return;

                const current = parseInt(badge.textContent || "0", 10) || 0;
                badge.textContent = (current + 1).toString();
                badge.style.display = "inline-block";
            }

            connection.start()
                .then(() => connection.invoke("JoinUserGroup", userEmail))
                .then(() => console.log("SignalR connected:", userEmail))
                .catch(err => console.error("SignalR error:", err));

            // 📩 Yeni mesaj
            connection.on("NewMessage", function (data) {
                showInboxBadgePlusOne();

                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'info',
                    title: 'Yeni Mesaj',
                    text: data.subject + ' (' + data.senderEmail + ')',
                    showConfirmButton: false,
                    timer: 3500
                });
            });

            // ✅ Mesaj okundu
            connection.on("MessageRead", function (data) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'Mesaj Okundu',
                    text: data.subject + ' okundu',
                    showConfirmButton: false,
                    timer: 3000
                });
            });

        })();
    </script>

</body>
</html>
