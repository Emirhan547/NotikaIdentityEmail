<!doctype html>
<html class="no-js" lang="tr">
@await Component.InvokeAsync("_UILayoutHead")
<body>

    @await Component.InvokeAsync("_UILayoutHeader")
    @await Component.InvokeAsync("_UILayoutMobileMenu")
    @await Component.InvokeAsync("_UILayoutNavbar")
    @await Component.InvokeAsync("_UILayoutBreadComb")

    @RenderBody()

    @using System.Security.Claims
    <input type="hidden"
           id="currentUserEmail"
           value="@(User.FindFirst(ClaimTypes.Email)?.Value
                                      ?? User.FindFirst("email")?.Value
                                      ?? "")" />

    @await Component.InvokeAsync("_UILayoutFooter")

    <!-- JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.2/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        (function () {

            const emailEl = document.getElementById("currentUserEmail");
            const userEmail = (emailEl?.value || "").trim();

            if (!userEmail) {
                console.warn("SignalR: userEmail not found.");
                return;
            }

            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/hubs/notification")
                .withAutomaticReconnect()
                .build();

            function showInboxBadgePlusOne() {
                const badge = document.getElementById("inboxBadge");
                if (!badge) return;

                const current = parseInt(badge.textContent || "0", 10) || 0;
                badge.textContent = (current + 1).toString();
                badge.style.display = "inline-block";
            }
                        function showNotificationBadgePlusOne() {
                const badge = document.getElementById("notificationBadge");
                if (!badge) return;

                const current = parseInt(badge.textContent || "0", 10) || 0;
                badge.textContent = (current + 1).toString();
                badge.style.display = "inline-block";
            }

            function prependNotificationItem(data) {
                const list = document.getElementById("notificationList");
                if (!list) return;

                const emptyState = list.querySelector(".hd-message-sn h3");
                if (emptyState && emptyState.textContent?.trim() === "Bildirim yok") {
                    list.innerHTML = "";
                }

                const detail = data.detail || "Yeni bir bildirim oluştu.";
                const shortDetail = detail.length > 70 ? detail.substring(0, 70) + "..." : detail;
                const imageUrl = data.imageUrl || "/notika-master/notika/green-horizotal/img/post/4.jpg";
                const title = data.title || "Sistem Bildirimi";

                const wrapper = document.createElement("a");
                wrapper.href = "#";
                wrapper.innerHTML = `
                    <div class="hd-message-sn">
                        <div class="hd-message-img">
                            <img src="${imageUrl}" alt="Bildirim" />
                        </div>
                        <div class="hd-mg-ctn">
                            <h3>${title}</h3>
                            <p>${shortDetail}</p>
                        </div>
                    </div>`;

                list.prepend(wrapper);
            }
            // ✅ DÜZELTME: Geliştirilmiş hata yönetimi
            connection.start()
                .then(() => connection.invoke("JoinUserGroup", userEmail))
                .then(() => console.log("✅ SignalR connected:", userEmail))
                .catch(err => {
                    console.error("❌ SignalR connection error:", err);

                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'warning',
                        title: 'Bağlantı Hatası',
                        text: 'Canlı bildirimler şu anda çalışmıyor.',
                        showConfirmButton: false,
                        timer: 4000
                    });
                });

            // ✅ YENİ: Otomatik yeniden bağlanma durumu
            connection.onreconnecting(error => {
                console.warn("⚠️ SignalR reconnecting...", error);
            });

            connection.onreconnected(connectionId => {
                console.log("✅ SignalR reconnected:", connectionId);
                connection.invoke("JoinUserGroup", userEmail).catch(console.error);
            });

            connection.onclose(error => {
                console.error("❌ SignalR connection closed:", error);
            });

            // 📩 Yeni mesaj
            connection.on("NewMessage", function (data) {
                showInboxBadgePlusOne();

                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'info',
                    title: 'Yeni Mesaj',
                    text: data.subject + ' (' + data.senderEmail + ')',
                    showConfirmButton: false,
                    timer: 3500
                });
            });
            connection.on("NewNotification", function (data) {
                showNotificationBadgePlusOne();
                prependNotificationItem(data);

                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'info',
                    title: data.title || 'Yeni Bildirim',
                    text: data.detail || 'Yeni bir bildirim oluştu.',
                    showConfirmButton: false,
                    timer: 3500
                });
            });
            // ✅ Mesaj okundu
            connection.on("MessageRead", function (data) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'Mesaj Okundu',
                    text: data.subject + ' okundu',
                    showConfirmButton: false,
                    timer: 3000
                });
            });

        })();
    </script>

</body>
</html>