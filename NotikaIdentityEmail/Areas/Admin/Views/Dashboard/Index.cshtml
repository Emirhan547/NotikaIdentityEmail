@model NotikaIdentityEmail.Areas.Admin.Models.DashboardViewModel
@using NotikaIdentityEmail.Models.Elastics

@{
    ViewData["Title"] = "Yönetim Paneli";

    var totalRead = Model.MessageCount - Model.UnreadMessageCount;
    var readRate = Model.MessageCount > 0
        ? (int)Math.Round((double)totalRead / Model.MessageCount * 100)
        : 0;

    var unreadRate = Model.MessageCount > 0
        ? (int)Math.Round((double)Model.UnreadMessageCount / Model.MessageCount * 100)
        : 0;
}

<div class="container-fluid px-4 py-5">

    <!-- 🎯 HERO SECTION -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-lg overflow-hidden" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body p-5 text-white">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h1 class="display-5 fw-bold mb-2">
                                <i class="fas fa-chart-line me-2"></i>Dashboard
                            </h1>
                            <p class="lead mb-0 opacity-90">
                                Sistem metriklerinizi gerçek zamanlı takip edin
                            </p>
                        </div>
                        <div class="text-end d-none d-md-block">
                            <p class="mb-1 opacity-75 small">Bugün</p>
                            <h4 class="mb-0 fw-bold">@DateTime.Now.ToString("dd MMMM yyyy")</h4>
                            <p class="mb-0 small">@DateTime.Now.ToString("HH:mm")</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 📊 İSTATİSTİK KARTLARI -->
    <div class="row g-4 mb-4">
        <!-- Kullanıcı -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 card-hover">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avatar-lg rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center">
                                <i class="fas fa-users fa-2x text-primary"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <p class="text-muted text-uppercase fw-semibold mb-1 small">Kullanıcılar</p>
                            <h3 class="mb-0 fw-bold">@Model.UserCount</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mesaj -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 card-hover">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avatar-lg rounded-circle bg-success bg-opacity-10 d-flex align-items-center justify-content-center">
                                <i class="fas fa-envelope fa-2x text-success"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <p class="text-muted text-uppercase fw-semibold mb-1 small">Toplam Mesaj</p>
                            <h3 class="mb-0 fw-bold">@Model.MessageCount</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Okunmamış -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 card-hover">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avatar-lg rounded-circle bg-warning bg-opacity-10 d-flex align-items-center justify-content-center">
                                <i class="fas fa-envelope-open fa-2x text-warning"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <p class="text-muted text-uppercase fw-semibold mb-1 small">Okunmamış</p>
                            <h3 class="mb-0 fw-bold">@Model.UnreadMessageCount</h3>
                            <span class="badge bg-warning bg-opacity-10 text-warning small">%@unreadRate</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hata -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 card-hover">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avatar-lg rounded-circle bg-danger bg-opacity-10 d-flex align-items-center justify-content-center">
                                <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <p class="text-muted text-uppercase fw-semibold mb-1 small">Son 24s Aktivite</p>
                            <h3 class="mb-0 fw-bold" id="errorCountDisplay">@Model.ErrorCountLast24h</h3>
                            <span class="badge bg-danger bg-opacity-10 text-danger small">
                                <i class="fas fa-sync-alt fa-spin me-1"></i>Canlı
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 📈 GRAFİKLER VE İSTATİSTİKLER -->
    <div class="row g-4 mb-4">
        <!-- Sol Taraf - Haftalık Trend -->
        <div class="col-xl-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 pt-4 pb-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h5 class="card-title mb-1 fw-bold">
                                <i class="fas fa-chart-area text-primary me-2"></i>
                                Kategori Bazlı Mesaj Dağılımı
                            </h5>
                            <p class="text-muted small mb-0">Kategorilere göre toplam mesaj sayısı</p>
                        </div>
                    </div>
                </div>
                <div class="card-body" style="height: 400px;">
                    <canvas id="categoryMessagesChart"
                            style="height: 100% !important;"
                            data-labels='@System.Text.Json.JsonSerializer.Serialize(Model.CategoryStats.Select(stat => stat.CategoryName))'
                            data-totals='@System.Text.Json.JsonSerializer.Serialize(Model.CategoryStats.Select(stat => stat.MessageCount))'>
                    </canvas>
                </div>
            </div>
        </div>

        <!-- Sağ Taraf - Mesaj Durumu -->
        <div class="col-xl-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 pt-4 pb-3">
                    <h5 class="card-title mb-1 fw-bold">
                        <i class="fas fa-chart-pie text-success me-2"></i>
                        Mesaj Durumu
                    </h5>
                    <p class="text-muted small mb-0">Okunma oranları</p>
                </div>
                <div class="card-body d-flex flex-column" style="height: 400px;">
                    <div class="flex-grow-1 d-flex align-items-center justify-content-center">
                        <canvas id="messageStatusChart"
                                style="max-height: 250px;"
                                data-read="@totalRead"
                                data-unread="@Model.UnreadMessageCount">
                        </canvas>
                    </div>

                    <div class="row g-3 mt-auto">
                        <div class="col-6">
                            <div class="p-3 rounded" style="background-color: rgba(34, 197, 94, 0.1);">
                                <p class="text-muted small mb-1">Okundu</p>
                                <h5 class="mb-0 fw-bold text-success">@totalRead</h5>
                                <small class="text-success">%@readRate</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 rounded" style="background-color: rgba(239, 68, 68, 0.1);">
                                <p class="text-muted small mb-1">Okunmadı</p>
                                <h5 class="mb-0 fw-bold text-danger">@Model.UnreadMessageCount</h5>
                                <small class="text-danger">%@unreadRate</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 📋 İÇERİK LİSTELERİ -->
    <div class="row g-4 mb-4">
        <!-- Son Mesajlar -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 pt-4 pb-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="card-title mb-0 fw-bold">
                            <i class="fas fa-inbox text-info me-2"></i>
                            Son Mesajlar
                        </h5>
                        <a asp-area="Admin" asp-controller="Message" asp-action="Index" class="btn btn-sm btn-outline-primary">
                            Tümünü Gör <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        @if (Model.RecentMessages.Any())
                        {
                            foreach (var message in Model.RecentMessages)
                            {
                                var subject = string.IsNullOrWhiteSpace(message.Subject) ? "(Konu yok)" : message.Subject;

                                <div class="list-group-item border-0 py-3 px-4 message-item">
                                    <div class="d-flex w-100 align-items-start">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="avatar-sm rounded-circle bg-light d-flex align-items-center justify-content-center">
                                                <i class="fas fa-envelope @(message.IsRead ? "text-muted" : "text-primary")"></i>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="d-flex w-100 justify-content-between align-items-start mb-1">
                                                <h6 class="mb-0 fw-semibold">@subject</h6>
                                                <span class="badge @(message.IsRead ? "bg-secondary" : "bg-danger") ms-2">
                                                    @(message.IsRead ? "Okundu" : "Yeni")
                                                </span>
                                            </div>
                                            <p class="mb-1 text-muted small">
                                                <i class="fas fa-user me-1"></i>@message.SenderEmail
                                            </p>
                                            <p class="mb-0 text-muted small">
                                                <i class="fas fa-tag me-1"></i>@message.CategoryName
                                                <span class="mx-2">•</span>
                                                <i class="fas fa-clock me-1"></i>@message.SendDate.ToString("dd.MM.yyyy HH:mm")
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="p-5 text-center text-muted">
                                <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                                <p class="mb-0">Henüz mesaj bulunmuyor</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Kategori İstatistikleri -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 pt-4 pb-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="card-title mb-0 fw-bold">
                            <i class="fas fa-chart-bar text-warning me-2"></i>
                            Kategori Dağılımı
                        </h5>
                        <a asp-area="Admin" asp-controller="Category" asp-action="Index" class="btn btn-sm btn-outline-primary">
                            Tümünü Gör <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    @if (Model.CategoryStats.Any())
                    {
                        foreach (var category in Model.CategoryStats)
                        {
                            var percentage = Model.MessageCount > 0
                            ? (int)Math.Round((double)category.MessageCount / Model.MessageCount * 100)
                            : 0;

                            var colors = new[] { "primary", "success", "info", "warning", "danger", "secondary" };
                            var colorIndex = Model.CategoryStats.ToList().IndexOf(category) % colors.Length;
                            var color = colors[colorIndex];

                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-folder text-@color me-2"></i>
                                        <span class="fw-semibold">@category.CategoryName</span>
                                    </div>
                                    <div class="text-end">
                                        <span class="fw-bold text-@color">@category.MessageCount</span>
                                        <span class="text-muted small ms-1">(%@percentage)</span>
                                    </div>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-@color"
                                         role="progressbar"
                                         style="width: @percentage%"
                                         aria-valuenow="@percentage"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-folder-open fa-3x mb-3 opacity-50"></i>
                            <p class="mb-0">Henüz kategori bulunmuyor</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- 🔍 ELASTİCSEARCH & SİSTEM LOGLARı -->
    @if (Model.LatestElasticLogs != null && Model.LatestElasticLogs.Any())
    {
        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 pt-4 pb-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <h5 class="card-title mb-0 fw-bold">
                                <i class="fas fa-terminal text-dark me-2"></i>
                                Sistem Logları (Elasticsearch)
                            </h5>
                            @if (Model.KibanaEnabled)
                            {
                                <a href="@Model.KibanaUrl" target="_blank" class="btn btn-sm btn-outline-dark">
                                    <i class="fas fa-external-link-alt me-1"></i>Kibana'da Aç
                                </a>
                            }
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 140px;">Zaman</th>
                                        <th style="width: 100px;">Seviye</th>
                                        <th>Mesaj</th>
                                        <th style="width: 200px;">Kullanıcı</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var log in Model.LatestElasticLogs)
                                    {
                                        var levelClass = log.Level?.ToLower() switch
                                        {
                                            "error" => "danger",
                                            "warning" => "warning",
                                            "information" => "info",
                                            "debug" => "secondary",
                                            _ => "dark"
                                        };

                                        var message = !string.IsNullOrEmpty(log.RenderedMessage) ? log.RenderedMessage : log.MessageTemplate;
                                        var user = !string.IsNullOrEmpty(log.UserEmail) ? log.UserEmail : (!string.IsNullOrEmpty(log.SenderEmail) ? log.SenderEmail : "Sistem");

                                        <tr class="log-row">
                                            <td class="small text-muted">
                                                <i class="far fa-clock me-1"></i>
                                                @log.Timestamp.ToString("dd.MM HH:mm:ss")
                                            </td>
                                            <td>
                                                <span class="badge bg-@levelClass">@log.Level</span>
                                            </td>
                                            <td class="small">
                                                <span class="text-truncate d-inline-block" style="max-width: 500px;" title="@message">
                                                    @message
                                                </span>
                                            </td>
                                            <td class="small text-muted">@user</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- 📦 EK İSTATİSTİKLER -->
    <div class="row g-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body py-4">
                    <div class="mb-3">
                        <i class="fas fa-folder-open fa-3x text-info"></i>
                    </div>
                    <h4 class="fw-bold mb-1">@Model.CategoryCount</h4>
                    <p class="text-muted mb-0 small">Kategori</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body py-4">
                    <div class="mb-3">
                        <i class="fas fa-file-alt fa-3x text-secondary"></i>
                    </div>
                    <h4 class="fw-bold mb-1">@Model.DraftCount</h4>
                    <p class="text-muted mb-0 small">Taslak</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body py-4">
                    <div class="mb-3">
                        <i class="fas fa-trash fa-3x text-danger"></i>
                    </div>
                    <h4 class="fw-bold mb-1">@Model.TrashCount</h4>
                    <p class="text-muted mb-0 small">Çöp Kutusu</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body py-4">
                    <div class="mb-3">
                        <i class="fas fa-bell fa-3x text-warning"></i>
                    </div>
                    <h4 class="fw-bold mb-1" id="adminNotificationCount">@Model.NotificationCount</h4>
                    <p class="text-muted mb-0 small">Bildirim</p>
                </div>
            </div>
        </div>
    </div>

</div>

@section Styles {
    <style>
        .card-hover {
            transition: transform 0.2s, box-shadow 0.2s;
        }

            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.15) !important;
            }

        .avatar-lg {
            width: 64px;
            height: 64px;
        }

        .avatar-sm {
            width: 40px;
            height: 40px;
        }

        .message-item {
            transition: background-color 0.2s;
        }

            .message-item:hover {
                background-color: rgba(0,0,0,0.02);
            }

        .log-row:hover {
            background-color: rgba(0,0,0,0.02);
        }

        .progress {
            border-radius: 10px;
            background-color: rgba(0,0,0,0.05);
        }

        .progress-bar {
            border-radius: 10px;
            transition: width 0.6s ease;
        }
    </style>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // 📊 Haftalık Mesaj Trendi Grafiği
        const categoryCanvas = document.getElementById('categoryMessagesChart');
         if (categoryCanvas) {
             const labels = JSON.parse(categoryCanvas.dataset.labels);
             const totals = JSON.parse(categoryCanvas.dataset.totals);

             new Chart(categoryCanvas, {
                 type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Toplam Mesaj',
                            data: totals,
                            backgroundColor: 'rgba(102, 126, 234, 0.35)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            borderRadius: 8,
                            maxBarThickness: 42
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            usePointStyle: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // 🥧 Mesaj Durumu Pasta Grafiği
        const statusCanvas = document.getElementById('messageStatusChart');
        if (statusCanvas) {
            const read = Number(statusCanvas.dataset.read);
            const unread = Number(statusCanvas.dataset.unread);

            new Chart(statusCanvas, {
                type: 'doughnut',
                data: {
                    labels: ['Okundu', 'Okunmadı'],
                    datasets: [{
                        data: [read, unread],
                        backgroundColor: [
                            '#22c55e',
                            '#ef4444'
                        ],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    var label = context.label || '';
                                    var value = context.parsed || 0;
                                    var total = read + unread;
                                    var percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return label + ': ' + value + ' (' + percentage + '%)';
                                }
                            }
                        }
                    },
                    cutout: '70%'
                }
            });
        }

        // 🔄 Hata sayısını her 30 saniyede bir güncelle
        setInterval(async function() {
            try {
                const response = await fetch('@Url.Action("GetErrorCount", "Dashboard", new { area = "Admin" })');
                const data = await response.json();
                document.getElementById('errorCountDisplay').textContent = data.count;
            } catch (error) {
                console.error('Hata sayısı güncellenirken bir sorun oluştu:', error);
            }
        }, 30000); // 30 saniye
    </script>
}